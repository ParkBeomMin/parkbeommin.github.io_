---
title: '[WEB] web push, ì´ë ‡ê²Œ ì‰¬ìš´ê±°ì˜€ì–´?'
date: 2023-07-28 09:43:00+09:00
categories: web web-push
---

<img src='/assets/web/banner.png'>

> ì‚¬ìš©ìë“¤ì—ê²Œ í‘¸ì‰¬ ì•Œë¦¼ì„ ë³´ë‚´ê³  ì‹¶ì€ë°..
> ë‚œ ì•± ê°œë°œìê°€ ì•„ë‹Œë°..  
> ì–¸ì œ ë˜ ì•± ê°œë°œ ê³µë¶€ë¥¼ í•˜ì§€..

ì•± ê°œë°œ ì•ˆí•´ë„ í‘¸ì‰¬ ì•Œë¦¼ì„ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤!  
ì›¹ í‘¸ì‰¬ë¥¼ í™œìš©í•˜ë©´ ë¸Œë¼ìš°ì €ì˜ í‘¸ì‰¬ ê¸°ëŠ¥ì„ ì…ë§›ëŒ€ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!

## ğŸ”‘ì›¹ í‘¸ì‰¬ êµ¬í˜„ì— ì•ì„œ..

ì›¹ í‘¸ì‰¬ êµ¬í˜„ì— ì•ì„œ ì‹¤ìŠµ í™˜ê²½ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.  
ë‹¤ë¥¸ í”„ë ˆì„ì›Œí¬ë¼ê³  í•˜ë”ë¼ë„ ê¸°ë³¸ì ì¸ êµ¬ì¡°ëŠ” ê°™ìœ¼ë‹ˆ ì´í•´í•˜ì‹œê¸°ì— ì–´ë µì§€ ì•Šìœ¼ì‹¤ ê²ë‹ˆë‹¤!

-   Vue (v3.3.4)
-   Node
-   Firebase firestore

( ëª¨ë°”ì¼ ê¸°ì¤€ )  
ì›¹ í‘¸ì‰¬ëŠ” ì¹´ì¹´ì˜¤ ë¸Œë¼ìš°ì € ë° ë„¤ì´ë²„ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.  
ì ì ˆí•œ ì¡°ì¹˜ë¥¼ ì·¨í•´ ê¸°ë³¸ ë¸Œë¼ìš°ì €(ì‚¼ì„±, í¬ë¡¬, ì‚¬íŒŒë¦¬)ë¡œ ìœ ë„í•´ì•¼í•©ë‹ˆë‹¤.  
IOSì˜ ê²½ìš°, 16.4ë²„ì „ ì´ìƒë¶€í„° í‘¸ì‰¬ ê¸°ëŠ¥ì´ ì§€ì›ë˜ë©° PWAë¡œ êµ¬í˜„í•˜ì—¬ ì•±ì„ ë‹¤ìš´ë¡œë“œ í›„ í‘¸ì‰¬ ê¸°ëŠ¥ì´ ì§€ì›ë©ë‹ˆë‹¤.

## ğŸ“ƒêµ¬ë… ë¶€íƒë“œë¦½ë‹ˆë‹¤.

ê°‘ìê¸° êµ¬ë…ì´ìš”..?

ì›¹ í‘¸ì‰¬ëŠ” êµ¬ë…ì„ í•œ ì‚¬ìš©ìì—ê²Œ í† í°ê°’ì„ ì–»ì–´ì„œ ë³´ë‚´ì•¼ í•©ë‹ˆë‹¤.  
êµ¬ë… ë²„íŠ¼ì„ ë§Œë“¤ì–´ ë´…ì‹œë‹¤.

êµ¬ë… ë²„íŠ¼ì„ ë§Œë“¤ê¸° ìœ„í•´ì„œëŠ” [Service Worker]ì™€ [PushManager]ë¥¼ ì‚¬ìš©í•´ì•¼í•©ë‹ˆë‹¤.

Vue í”„ë¡œì íŠ¸ì˜ `/public` í´ë”ì— `service-worker.js` íŒŒì¼ì„ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.

```
// ì›¹ í‘¸ì‰¬ ìˆ˜ì‹  ì‹œ
self.addEventListener('push', (event) => {
    const text = event.data.text();
    event.waitUntil(
        self.registration.showNotification('ì›¹ í‘¸ì‰¬!', {
            body: text,
            data: {
                url: 'https://github.io/ParkBeomMin/WebPushExample',
            },
        })
    );
});

// í‘¸ì‰¬ ì•Œë¦¼ í´ë¦­ ì‹œ
self.addEventListener('notificationclick', function (event) {
    event.notification.close();
    event.waitUntil(clients.openWindow(event.notification.data.url));
});

```

pushì™€ notificationclick ì´ë²¤íŠ¸ë¥¼ ë“±ë¡ì‹œì¼œì¤ë‹ˆë‹¤.  
event.data.text()ë¥¼ í†µí•´ í‘¸ì‰¬ ì•Œë¦¼ì— ë³´ì—¬ì¤„ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê³  showNotificationì˜ bodyê°’ì— ë¿Œë ¤ì¤ë‹ˆë‹¤.  
showNotificationì˜ ì²«ë²ˆì§¸ ì¸ìëŠ” í‘¸ì‰¬ì•Œë¦¼ì˜ íƒ€ì´í‹€ë‹ˆë‹ˆë‹¤.  
url ë¶€ë¶„ì€ notificationclick ì´ë²¤íŠ¸ì—ì„œ í‘¸ì‰¬ í´ë¦­ ì‹œ ì´ë™í•  url ê²½ë¡œì…ë‹ˆë‹¤.

ì´ì œ `HomeView.vue` íŒŒì¼ë¡œ ì´ë™í•˜ì—¬ êµ¬ë… ë²„íŠ¼ê³¼ service worker íŒŒì¼ì„ ë“±ë¡í•˜ê³  êµ¬ë…ì„ í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•´ë³´ê² ìŠµë‹ˆë‹¤.

```
<template>
    <div>
        <button @click="requestPermission">{{ buttonText }}</button>
    </div>
</template>
```

ë²„íŠ¼ì€ ìœ„ì™€ ê°™ì´ ë§Œë“¤ê³ , buttonTextëŠ” êµ¬ë…ê³¼ êµ¬ë…í•´ì§€ë¥¼ ìœ„í•´ ë³€í™”ë  ìˆ˜ ìˆë„ë¡ í–ˆìŠµë‹ˆë‹¤.

```
...

const buttonText = ref('');

onMounted(async () => {
    // Service Worker ë“±ë¡ ì½”ë“œ
    if ('serviceWorker' in navigator) {
        const workerFile = '/service-worker.js';
        try {
            const registration = await navigator.serviceWorker.register(workerFile);
            if (registration) {
                const subscription = await registration.pushManager.getSubscription();
                if (subscription) {
                    buttonText.value = 'êµ¬ë… í•´ì§€í•˜ê¸°';
                } else {
                    buttonText.value = 'êµ¬ë…í•˜ê¸°';
                }
            }
        } catch (e) {
            console.error(e.message);
        }
    } else {
        console.error('Service Worker in navigator error');
    }
});

...
```

ì´ì œ service workerê°€ ë“±ë¡ì´ ë˜ì—ˆìœ¼ë‹ˆ, êµ¬ë… ìš”ì²­ ê¸°ëŠ¥ì„ êµ¬í˜„í•´ë³´ê² ìŠµë‹ˆë‹¤.

```
...
const requestPermission = async () => {
    try {
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();
        if (subscription) {
            // ì´ë¯¸ êµ¬ë…ì´ ë˜ì–´ìˆë‹¤ë©´ í•´ì§€í•˜ê¸°
            // TODO: DBì— êµ¬ë… í•´ì§€ ì •ë³´ ë³´ë‚´ê¸°
            buttonText.value = 'êµ¬ë…í•˜ê¸°';
            subscription.unsubscribe();
        } else {
            // êµ¬ë…ì´ ë˜ì–´ìˆì§€ ì•Šìœ¼ë©´ êµ¬ë…í•˜ê¸°
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: vapidKey.value,
            });
            // TODO: DBì— êµ¬ë… ì •ë³´ ë³´ë‚´ê¸°
            console.log('subscription => ', subscription.toJSON());
            buttonText.value = 'êµ¬ë… í•´ì§€í•˜ê¸°';
        }
    } catch (e) {
        console.error(e.message);
    }
};
...

```

ìš”ì²­ì€ service workerê°€ ë“±ë¡ë˜ê³  ì¤€ë¹„ê°€ ëœ ì´í›„ pushManagerì˜ getSubscription()ë¥¼ í†µí•´ êµ¬ë…ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.  
êµ¬ë…ì´ ë˜ì–´ìˆë‹¤ë©´ í•´ì§€, ë˜ì–´ìˆì§€ ì•Šë‹¤ë©´ êµ¬ë…ì„ í•©ë‹ˆë‹¤.  
ëœ¬ê¸ˆì—†ì´ `vapidKey.value` ì´ ì¹œêµ¬ê°€ ë‚˜íƒ€ë‚¬ëŠ”ë° í‘¸ì‰¬ ë°œì†¡ì„ ìœ„í•œ í‚¤ê°’ì…ë‹ˆë‹¤. ì´ í‚¤ê°’ì€ ì„œë²„ë‹¨ì—ì„œ ë§Œë“¤ì–´ì•¼í•©ë‹ˆë‹¤.

ì´ì œ Node í”„ë¡œì íŠ¸ë¡œ ì´ë™í•©ë‹ˆë‹¤.

`npm install -g web-push`  
`web-push generate-vapid-keys`

```
=======================================

Public Key:
BAHc42Ge9Ku-Hgup-66JXrkbsWuwDTUTnoh0Y5UyQFyS04UbP7NF02ZfOMMDf2ujLTMIfKlQ4cx4Thz8ek6hze8

Private Key:
TdolN_-xYH9ARuWRDULgaXO-EFgadIM39FhCSttwswc

=======================================
```

ìœ„ ëª…ë ¹ì–´ë¥¼ í†µí•´ web-pushë¥¼ ì„¤ì¹˜í•˜ê³ , vapid key ê°’ì„ ë°œê¸‰ë°›ìŠµë‹ˆë‹¤.
ë°œê¸‰ë°›ì€ vapid key ê°’ ì¤‘ Public Keyë¥¼ ìœ„ì—ì„œ ì–¸ê¸‰ë˜ì—ˆë˜ `vapidKey.value`ì— ë„£ì–´ì¤ë‹ˆë‹¤.

```
const vapidKey = ref('BAHc42Ge9Ku-Hgup-66JXrkbsWuwDTUTnoh0Y5UyQFyS04UbP7NF02ZfOMMDf2ujLTMIfKlQ4cx4Thz8ek6hze8');
```

ì´ì œ êµ¬ë… ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ ì•Œë¦¼ ìš”ì²­ê³¼ êµ¬ë… ì •ë³´ë¥¼ ë°›ì•„ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<img src='/assets/web/web-push-1.png'>

<img src='/assets/web/web-push-2.png'>

ì´ êµ¬ë… ì •ë³´ë¥¼ ê°€ì§€ê³  ë‹¤ì‹œ Node í”„ë¡œì íŠ¸ë¡œ ì´ë™í•©ë‹ˆë‹¤.
`npm install --save web-push`

ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ í›„ vapidí‚¤ì™€ êµ¬ë…ì •ë³´ë¥¼ í¬í•¨í•´ í‘¸ì‰¬ ë°œì†¡ ë¡œì§ì„ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.

```
const webpush = require('web-push');

const vapidKeys = {
    publicKey: 'BAHc42Ge9Ku-Hgup-66JXrkbsWuwDTUTnoh0Y5UyQFyS04UbP7NF02ZfOMMDf2ujLTMIfKlQ4cx4Thz8ek6hze8',
    privateKey: 'TdolN_-xYH9ARuWRDULgaXO-EFgadIM39FhCSttwswc',
};

webpush.setVapidDetails('mailto:bmpark@jinhak.com', vapidKeys.publicKey, vapidKeys.privateKey);

webpush.sendNotification(
    {
        endpoint:
            'https://fcm.googleapis.com/fcm/send/cRngP9o7apw:APA91bG5_i-BS2WBUSehlWxe4Pr2PLhugyvCtIcNgFSs2RcSSth60wmC61R9SH-Iq3tFpO1tqprXcFFze4ZduL-MsSGWP9DJvm7jEbWB3nM40Ui99VFNPsnoHUx-emEceevzR6vwATMn',
        keys: {
            auth: 'BjJjTUVFQi9UCBH-VqqVAg',
            p256dh: 'BDDJ_YGSawW1NowpbJ1Cl0N8JiFtsSuMBjjtWCly7lBrf4wnsrJP7xlVTqBKhhaMIP3RwkCfb5oSSwDVh1fbYp4',
        },
    },
    'ì›¹í‘¸ì‰¬ë°œì†¡!'
);

```

ì´ì œ `node index.js`ë¡œ ì„œë²„ë¥¼ ì‹¤í–‰ì‹œí‚¤ë©´ ì›¹ í‘¸ì‰¬ ë°œì†¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!

<img src='/assets/web/web-push-3.png'>

## ğŸ’»RESTFulí•œ WebPushë¡œ!

ìœ„ì—ì„œ ë‹¨ìˆœíˆ ì›¹ í‘¸ì‰¬ê°€ ë™ì‘í•˜ëŠ” ê²ƒê¹Œì§€ í–ˆìœ¼ë‹ˆ, ì´ì œ dbë„ ì—°ê²°í•˜ê³  ì„œë²„ apië¡œ ì›¹ í‘¸ì‰¬ê°€ ë°œì†¡ë  ìˆ˜ ìˆë„ë¡ í•´ë³´ê² ìŠµë‹ˆë‹¤.
Node í”„ë¡œì íŠ¸ë¡œ ì´ë™í•©ë‹ˆë‹¤.

`npm install express --save`  
`npm install firebase-admin --save`

firebase consoleì—ì„œ í‚¤ê°’ íŒŒì¼ë„ ë‹¤ìš´ë¡œë“œ ë°›ì•„ë†“ìŠµë‹ˆë‹¤.  
firebase project > í”„ë¡œì íŠ¸ ì„¤ì • > ì„œë¹„ìŠ¤ ê³„ì • > ìƒˆ ë¹„ê³µê°œ í‚¤ ìƒì„±

ì´ì œ ê¸°ë³¸ì ì¸ ì…‹íŒ…ì€ ì™„ë£Œê°€ ë˜ì—ˆê³ , êµ¬ì¡°ë¥¼ ì¡ê³  êµ¬í˜„ì„ í•©ë‹ˆë‹¤.

```
â”œâ”€â”€ routes
â”‚   â”œâ”€â”€ index.js
â”‚   â””â”€â”€ webPush.js
â”œâ”€â”€ firebase-account-file.json
â”œâ”€â”€ firebase.js
â”œâ”€â”€ index.js
â”œâ”€â”€ webPush.controller.js
â””â”€â”€ package.json
```

ê¸°ì¡´ `index.js`ì˜ webPush ê¸°ëŠ¥ë“¤ì€ `webPush.controller.js`íŒŒì¼ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.  
ì´ì œ ê° íŒŒì¼ì— ëŒ€í•´ íŒŒí—¤ì³ë³´ê² ìŠµë‹ˆë‹¤.

ë¨¼ì € `index.js` íŒŒì¼ì€ ê¸°ë³¸ì ì¸ express ë¼ìš°íŒ… ì²˜ë¦¬ë¥¼ í•´ì¤ë‹ˆë‹¤.

```
const express = require('express');
const app = express();

app.use(express.urlencoded({ extended: false }));
app.use(express.json());

const index = require('./routes/index');
app.use('/', index);

app.listen(3000, () => console.log('WebPush Server On 3000 Port'));

```

`webPush.controller.js`ì—ì„œëŠ” vapidkeyì™€ pushë¥¼ ë³´ë‚´ëŠ” í•¨ìˆ˜ë¥¼ exportì‹œì¼œì¤ë‹ˆë‹¤.  
vapidKeyëŠ” ì„œë²„ì—ì„œ ë°œê¸‰ë°›ì€ í‚¤ë¥¼ ê³ ì •ìœ¼ë¡œ í”„ë¡ íŠ¸ì™€ ê°™ê²Œ ì‚¬ìš©í•´ì•¼í•˜ê¸° ë•Œë¬¸ì— Vapidê°’ì„ ë³´ë‚´ì£¼ëŠ” í•¨ìˆ˜ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.  
dev, production í™˜ê²½ì—ì„œ ê°ê° ë‹¬ë¼ì§€ë¯€ë¡œ cross-envë¥¼ í™œìš©í•´ configê°’ìœ¼ë¡œ ì…‹íŒ…í•˜ì—¬ ì‚¬ìš©í•´ë„ ì¢‹ìŠµë‹ˆë‹¤!

```
const webpush = require('web-push');

const vapidKeys = {
    publicKey: 'BAHc42Ge9Ku-Hgup-66JXrkbsWuwDTUTnoh0Y5UyQFyS04UbP7NF02ZfOMMDf2ujLTMIfKlQ4cx4Thz8ek6hze8',
    privateKey: 'TdolN_-xYH9ARuWRDULgaXO-EFgadIM39FhCSttwswc',
};

webpush.setVapidDetails('mailto:club20608@gmail.com', vapidKeys.publicKey, vapidKeys.privateKey);

const getVapidKey = () => {
    return vapidKeys.publicKey;
};

const push = ({ data, tokens }) => {
    tokens.forEach(async (token) => {
        try {
            await webpush.sendNotification(token, data.message);
        } catch (e) {
            console.error(e);
        }
    });
};

module.exports = { getVapidKey, push };
```

`firebase.js`ì—ì„œëŠ” firebaseë¥¼ ì´ˆê¸°í™”í•˜ê³  firestore dbì™€ í†µì‹ í•˜ëŠ” ê¸°ëŠ¥ë“¤ì„ êµ¬í˜„í•©ë‹ˆë‹¤.  
í† í°ì„ dbì— ì¶”ê°€/ì‚­ì œí•˜ê³  ê°€ì ¸ì™€ì„œ ë°œì†¡ì²˜ë¦¬ë¥¼ í•©ë‹ˆë‹¤.

```
const { initializeApp, applicationDefault, cert } = require('firebase-admin/app');
const { getFirestore } = require('firebase-admin/firestore');
const { push } = require('./webPush.controller');

const serviceAccount = require('./firebase-account-file.json');

initializeApp({
    credential: cert(serviceAccount),
});

const db = getFirestore();

const setToken = async ({ endpoint, keys }) => {
    let isExist = false;
    const q = db.collection('token').where('endpoint', '==', endpoint);
    const querySnapshot = await q.get();
    querySnapshot.forEach((doc) => {
        if (doc.id) {
            isExist = true;
        }
    });
    if (!isExist) {
        const today = new Date();
        db.collection('token').add({
            endpoint,
            keys,
            regDate: today,
        });
    }
};

const deleteToken = async ({ endpoint, keys }) => {
    const q = db.collection('token').where('endpoint', '==', endpoint); // query(collection(db, 'token'), where('endpoint', '==', true));
    const querySnapshot = await q.get();
    querySnapshot.forEach((doc) => {
        if (doc.id) {
            db.doc(`token/${doc.id}`).delete();
        }
    });
};

const sendMessage = async () => {
    const registrationTokens = [];
    const docs = await db.collection('token').get();
    // ë””ë¹„ì— ë“±ë¡ëœ í† í° ê°€ì ¸ì˜¤ê¸°
    docs.forEach((result) => {
        registrationTokens.push({ ...result.data() });
    });

    const message = {
        data: {
            message: 'ì›¹í‘¸ì‰¬!',
        },
        tokens: registrationTokens.filter((r) => r.endpoint),
    };

    try {
        push(message);
    } catch (e) {
        console.log(e);
    }
    return;
};

module.exports = {
    setToken,
    sendMessage,
    deleteToken,
};

```

`routes/index.js`ì—ì„œëŠ” webPush ê²½ë¡œë¡œ ë¼ìš°íŒ… í•´ì¤ë‹ˆë‹¤.

```
const express = require('express');

const router = express.Router();

router.use(express.urlencoded({ extended: false }));
router.use(express.json());

const webPush = require('./webPush.js');
router.use('/webPush', webPush);

module.exports = router;

```

ë§ˆì§€ë§‰ìœ¼ë¡œ `routes/webPush.js`ì—ì„œ ê° apië“¤ì„ êµ¬í˜„í•´ì¤ë‹ˆë‹¤.

```
const express = require('express');
const { setToken, deleteToken, sendMessage } = require('../firebase');
const { getVapidKey } = require('../webPush.controller');
const router = express.Router();

router.use(express.urlencoded({ extended: false }));
router.use(express.json());

router.get('/', async (req, res) => {
    res.json({ rtCode: 'S', vapidKey: getVapidKey() });
});

router.post('/', (req, res) => {
    const { endpoint, keys } = req.body;
    setToken({ endpoint, keys });
    res.json({ rtCode: 'S' });
});

router.post('/delToken', (req, res) => {
    const { endpoint } = req.body;
    deleteToken({ endpoint: decodeURIComponent(endpoint) });
    res.json({ rtCode: 'S' });
});

router.post('/send', (req, res) => {
    sendMessage();
    res.json({ rtoCode: 'S' });
});

module.exports = router;
```

ì´ì œ Vue í”„ë¡œì íŠ¸ë¡œ ì´ë™í•˜ì—¬ api í˜¸ì¶œì„ êµ¬í˜„í•©ë‹ˆë‹¤.

`npm i --save axios`

`main.ts`ë¡œ ì´ë™í•˜ì—¬ axiosë¥¼ ê¸€ë¡œë²Œí•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë“±ë¡í•´ì¤ë‹ˆë‹¤.

```
...
import axios from 'axios';

const app = createApp(App);

app.config.globalProperties.$axios = axios;

app.use(router);

app.mount('#app');

```

ì´ì œ `vite.config.ts`ë¡œ ì´ë™í•˜ì—¬ api ì„œë²„ê°€ ì œëŒ€ë¡œ í˜¸ì¶œë  ìˆ˜ ìˆë„ë¡ server ì„¤ì •ì„ í•´ì¤ë‹ˆë‹¤.

```
export default defineConfig({
    ...
    server: {
        port: 3001,
        cors: true,
        proxy: {
            '/api': {
                target: 'http://localhost:3000',
                changeOrigin: true,
                rewrite: (path) => path.replace(/^\/api/, ''),
            },
        },
    },
    ...
});

```

í˜ì´ì§€ ëœë”© ì‹œ vapidKey ê°’ì„ ë°›ì•„ì™€ì„œ ì…‹íŒ…ë  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

```

import { onMounted, getCurrentInstance, ref, nextTick } from 'vue';

const instance = getCurrentInstance();
const vapidKey = ref('');

onMounted(async () => {

  const ds = await (instance?.proxy as any).$axios.get('/api/webPush');
  vapidKey.value = ds.data.vapidKey;

  ...
})
```

`requestPermission` í•¨ìˆ˜ì—ì„œ TODOë¡œ ë‚¨ê²¨ë†“ì•˜ë˜ ë¶€ë¶„ì—ë„ í† í°ê°’ì´ ì…‹íŒ…ë  ìˆ˜ ìˆë„ë¡ ì¶”ê°€í•´ì¤ë‹ˆë‹¤.

```

const requestPermission = async () => {
    try {
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();
        if (subscription) {
            // ì´ë¯¸ êµ¬ë…ì´ ë˜ì–´ìˆë‹¤ë©´ í•´ì§€í•˜ê¸°
            await (instance?.proxy as any).$axios.post(`/api/webPush/delToken`, subscription);
            buttonText.value = 'êµ¬ë…í•˜ê¸°';
            subscription.unsubscribe();
        } else {
            // êµ¬ë…ì´ ë˜ì–´ìˆì§€ ì•Šìœ¼ë©´ êµ¬ë…í•˜ê¸°
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: vapidKey.value,
            });
            console.log('subscription => ', subscription.toJSON());
            await (instance?.proxy as any).$axios.post('/api/webPush', subscription);
            buttonText.value = 'êµ¬ë… í•´ì§€í•˜ê¸°';
        }
    } catch (e) {
        console.error(e.message);
    }
};
```

ì´ì œ êµ¬ë… ë²„íŠ¼ í´ë¦­ ì‹œ DBì— í† í°ì´ ì €ì¥ë˜ê³  ëª¨ë“  ì…‹íŒ…ì´ ëë‚¬ìŠµë‹ˆë‹¤.  
postman í”„ë¡œê·¸ë¨ìœ¼ë¡œ `/webPush/send` apië¥¼ í˜¸ì¶œí•˜ë©´ ì›¹ í‘¸ì‰¬ê°€ ì •ìƒì ìœ¼ë¡œ ì˜¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!

<img src='/assets/web/web-push-4.png'>

## ğŸ˜® IOSëŠ”ìš”??

IOSëŠ” ì²˜ìŒì— ë§ì”€ë“œë¦° ê²ƒê³¼ ê°™ì´ ì‚¬íŒŒë¦¬ 16.4 ë²„ì „ ì´ìƒì—ì„œ ë™ì‘ì´ ê°€ëŠ¥í•˜ë©° PWAë¡œ ë§Œë“¤ì–´ì•¼í•©ë‹ˆë‹¤.  
PWAë¡œ ë§Œë“œëŠ” ê²ƒì€ ê¸°ì¡´ ì›¹ì‚¬ì´íŠ¸ì— Manifestë§Œ ë“±ë¡í•´ì£¼ë©´ ë©ë‹ˆë‹¤!

Vue í”„ë¡œì íŠ¸ë¡œ ì´ë™í•˜ì—¬ `public/manifest.json` íŒŒì¼ì„ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.  
icon íŒŒì¼ë“¤ì€ [favicon-generator]ì‚¬ì´íŠ¸ì—ì„œ ë§Œë“¤ì–´ì£¼ë©´ í¸ë¦¬í•©ë‹ˆë‹¤.

```
{
        "short_name": "ì›¹í‘¸ì‰¬",
        "name": "ì›¹í‘¸ì‰¬",
        "start_url": "/",
        "id": "webpush",
        "display": "standalone",
        "theme_color": "#ffc107",
        "backgroun_color": "#ffc107",
        "icons": [
            {
                "src": "/android-icon-36x36.png",
                "sizes": "36x36",
                "type": "image/png",
                "density": "0.75"
            },
            {
                "src": "/android-icon-48x48.png",
                "sizes": "48x48",
                "type": "image/png",
                "density": "1.0"
            },
            {
                "src": "/android-icon-72x72.png",
                "sizes": "72x72",
                "type": "image/png",
                "density": "1.5"
            },
            {
                "src": "/android-icon-96x96.png",
                "sizes": "96x96",
                "type": "image/png",
                "density": "2.0"
            },
            {
                "src": "/android-icon-144x144.png",
                "sizes": "144x144",
                "type": "image/png",
                "density": "3.0"
            },
            {
                "src": "/android-icon-192x192.png",
                "sizes": "192x192",
                "type": "image/png",
                "density": "4.0"
            }
        ]
    }
```

ê·¸ë¦¬ê³  `index.html`ë¡œ ê°€ì„œ headíƒœê·¸ ì•ˆì— mainfestíŒŒì¼ì„ ë“±ë¡í•´ì¤ë‹ˆë‹¤.

```
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" href="/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vite App</title>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
```

ì´ì œ ì‹¤í–‰ì„ ì‹œì¼œë³´ë©´ ì•„ë˜ì™€ ê°™ì´ ì•±ì„ ë‹¤ìš´ë¡œë“œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
IOS í™˜ê²½ì—ì„œëŠ” 'í™ˆí™”ë©´ì— ì¶”ê°€'ë¥¼ í†µí•´ ì•±ì´ ì„¤ì¹˜ê°€ ë˜ê³ , êµ¬ë…ë²„íŠ¼ì„ ëˆŒëŸ¬ ì›¹ í‘¸ì‰¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<img src='/assets/web/web-push-5.png'>

[Service Worker]: (https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
[PushManager]: (https://developer.mozilla.org/en-US/docs/Web/API/PushManager)
[favicon-generator]: (https://www.favicon-generator.org/)
